# tuxtape-poc

This repo contains a proof of concept for TuxTape: a Linux kernel livepatching solution.

> Note: TuxTape only supports kernels based on minor versions currently supported by the mainline kernel maintainers. Do not expect TuxTape to provide backported LTS-like support to non-LTS kernels.

This branch does not contain all of the future aspects of TuxTape which will compile the patches and distribute them to clients, nor the client which makes requests for and installs those patches.

It builds four different binaries, which are detailed below.

## tuxtape-cve-parser

Parses the CVEs catalogued by the Linux kernel maintainers and generates a sqlite database of patch files. 
Since this project requires the full Linux Stable branch to be pulled and thousands of patches to be generated and CVE data pulled from NIST APIs,
the first run will take a decent amount of time to complete (likely over an hour). Each successive run takes less time as the commit history of the kernel will only be pulled on first run, and successive runs only build patches
from the diff of the `HEAD` of the `vulns` repo at the last run and the current `HEAD`.
This should be run as a cronjob to update the database periodically. This database can be used in livepatching
solutions.

The database is hardcoded to reside at `~/.cache/tuxtape-server/db.db3`.

> WARNING: Since the patch files are automatically generated, this program should undergo extensive testing
which has not yet been done before being used in production.

## tuxtape-server

The server is used to query the sqlite database created by `tuxtape-cve-parser` and provide a gRPC API for clients like `tuxtape-dashboard` to utilize for the creation of `kpatch`-compatible patches (referred to as "deployable" patches).

## tuxtape-kernel-builder

This is an additional server that registers itself to `tuxtape-server` upon startup and serves requests to build kernels from configs generated by `tuxtape-dashboard`. Once it is done, it reports the build profile (what files were included in the build) back to `tuxtape-server` and it gets added to the database.

> Note: This also requires the full git history of the Linux kernel to be pulled, so the first open will take a rather long time. If you already have the repo cloned, feel free to copy it to `~/.cache/tuxtape-kernel-builder/git/linux`.

## tuxtape-dashboard

A TUI dashboard used to create deployable patches from the "raw" patches stored in `tuxtape-server` and added to its database created by `tuxtape-cve-parser`. It will also be used to review deployable patches written by other kernel developers and deploy them to the fleet once approved. This dashboard is also used to create new kernel configs.

> Note: This also requires the full git history of the Linux kernel to be pulled, so the first open will take a rather long time. If you already have the repo cloned, feel free to copy it to `~/.cache/tuxtape-dashboard/git/linux`.

More detailed information about the TUI architecture can be found at `src/dashboard/README.md`.

## Dependencies (Ubuntu 24.04)

Build dependencies:
```
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

sudo apt install build-essential pkg-config libssl-dev protobuf-compiler 
```

Runtime dependencies for both `tuxtape-kernel-builder` and `tuxtape-dashboard`
```
sudo apt install libncurses-dev bison flex libelf-dev
```

Additional runtime dependency for `tuxtape-kernel-builder`
```
sudo apt install remake
```

## Running instructions

```
# To build
cargo build --all

# For the parser
cargo run --bin tuxtape-cve-parser

# For the server
cargo run --bin tuxtape-server

# For the kernel builder
cargo run --bin tuxtape-kernel-builder

# For the dashboard
cargo run --bin tuxtape-dashboard
```

## Testing TLS

If you wish to test TLS, you will need certificates. To create self-signed certificates, follow the directions below:

> Note: The following contains instructions for running only `tuxtape-server` and `tuxtape-dashboard` with TLS. To run `tuxtape-kernel-builder` with TLS, follow the same instructions, but keep in mind that you will need to generate a new CA with a different domain (like `tuxtape-kernel-builder.com`) as that is also a server, and you will need to create another entry for that domain in `/etc/hosts`.

1. Create an encrypted certificate authority

```
openssl genrsa -aes256 -out ca-key.pem 4096
```

2. Decrypt the certificate authority

```
openssl req -new -x509 -sha256 -days 365 -key ca-key.pem -out ca.pem
```

3. Extract the public certificate from the cert key

```
openssl genrsa -out cert-key.pem 4096
```

4. Create a certificate signing request

```
openssl req -new -sha256 -subj "/CN=tuxtapecn" -key cert-key.pem -out cert.csr
```

5. Create an extfile

```
echo "subjectAltName=DNS:tuxtape-server.com,IP:127.0.0.1" >> extfile.cnf
```

6. Create a complete certificate authority

```
openssl x509 -req -sha256 -days 365 -in cert.csr -CA ca.pem -CAkey ca-key.pem -out cert.pem -extfile extfile.cnf -CAcreateserial
```

7. Create a full chain

```
cat cert.pem > fullchain.pem
cat ca.pem >> fullchain.pem
```

8. Create a local domain name for the server in `/etc/hosts`.

```
sudo sh -c "echo '127.0.0.1 tuxtape-server.com' >> /etc/hosts"
```

9. Modify the `tuxtape-dashboard` config file at `.config/tuxtape-dashboard-config.toml` (this will eventually be moved to a config directory that doesn't reside in the source code) to enable TLS by setting the following values:

```
[database]
server_url = "tuxtape-server.com:50051"
use_tls = true
tls_cert_path = "ca.pem"
```


10. Run the server and client with the following arguments.

```
cargo run --bin tuxtape-server -- -t --tls-cert-path fullchain.pem --tls-key-path cert-key.pem --tls-ca-path ca.pem

cargo run --bin tuxtape-dashboard
```
